<!doctype html>
<html lang="en">
  <head>
    <script>
      /**
       * Shopify App Installation Handler
       * Captures shop data when app is installed and stores it in database
       */
      (function() {
        // Get shop parameter from URL
        const params = new URLSearchParams(window.location.search);
        const shop = params.get("shop");
        const storeName = params.get("store_name") || params.get("name");

        if (shop) {
          // Normalize shop domain
          let shopDomain = shop.trim();
          if (!shopDomain.endsWith('.myshopify.com') && !shopDomain.includes('.')) {
            shopDomain = `${shopDomain}.myshopify.com`;
          }

          // Extract store name from domain if not provided
          let finalStoreName = storeName;
          if (!finalStoreName) {
            const domainParts = shopDomain.split('.');
            finalStoreName = domainParts[0] || shopDomain;
          }

          // Function to register shop data with backend
          async function registerShopData() {
            try {
              const response = await fetch('/api/auth/register-shop', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  shop_domain: shopDomain,
                  store_name: finalStoreName,
                }),
              });

              if (response.ok) {
                const data = await response.json();
                console.log('Shop registered successfully:', data);
                return data;
              } else {
                const error = await response.json();
                console.error('Failed to register shop:', error);
                return null;
              }
            } catch (error) {
              console.error('Error registering shop:', error);
              return null;
            }
          }

          // Register shop data immediately when app loads
          registerShopData();

          // Handle redirect for Shopify app installation flow
          if (window.location.pathname === "/") {
            // Check if we're in an iframe (Shopify embedded app)
            const isEmbedded = window.self !== window.top;
            
            if (isEmbedded) {
              // For embedded apps, stay on current page
              // The React app will handle the rest
            } else {
              // For non-embedded access, redirect to OAuth if not authenticated
              // This will be handled by the React app routing
            }
          }
        }
      })();
    </script>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ReportPro - Easy Report</title>
    
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

